<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>grizabella.db_layers.kuzu.kuzu_adapter &mdash; Grizabella API 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=01f34227"></script>
        <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Grizabella API
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_client.html">API Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../core_models.html">Core Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../core_query_models.html">Core Query Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../core_exceptions.html">Core Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../core_db_manager.html">Core DB Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../core_query_engine.html">Core Query Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../core_utils.html">grizabella.core (Utilities)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../db_layers.html">grizabella.db_layers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ui_main.html">grizabella.ui (Main Components)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ui_dialogs.html">grizabella.ui.dialogs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Grizabella API</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">grizabella.db_layers.kuzu.kuzu_adapter</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for grizabella.db_layers.kuzu.kuzu_adapter</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Grizabella adapter for KuzuDB graph database.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span> <span class="c1"># Added</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span> <span class="c1"># For logging thread ID</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">kuzu</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">grizabella.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">InstanceError</span><span class="p">,</span> <span class="n">SchemaError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grizabella.core.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">EmbeddingDefinition</span><span class="p">,</span>
    <span class="n">EmbeddingInstance</span><span class="p">,</span>
    <span class="n">ObjectInstance</span><span class="p">,</span>
    <span class="n">PropertyDataType</span><span class="p">,</span>
    <span class="c1"># These are also needed for TYPE_CHECKING block if it were to use them directly</span>
    <span class="c1"># ObjectTypeDefinition, # Already aliased</span>
    <span class="c1"># RelationTypeDefinition # Already aliased</span>
    <span class="n">RelationInstance</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># import pandas as pd # Removed as get_as_df() was problematic</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grizabella.core.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ObjectTypeDefinition</span> <span class="k">as</span> <span class="n">ObjectTypeDefinitionModel</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grizabella.core.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">RelationTypeDefinition</span> <span class="k">as</span> <span class="n">RelationTypeDefinitionModel</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grizabella.core.query_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">GraphTraversalClause</span>  <span class="c1"># Added for new method</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grizabella.db_layers.common.base_adapter</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseDBAdapter</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span> <span class="c1"># Added logger instantiation</span>

<div class="viewcode-block" id="KuzuAdapter">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">KuzuAdapter</span><span class="p">(</span><span class="n">BaseDBAdapter</span><span class="p">):</span>  <span class="c1"># pylint: disable=R0904</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grizabella adapter for KuzuDB.</span>
<span class="sd">    Handles graph node and relationship table schema management.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: Initializing in thread ID: </span><span class="si">{</span><span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()</span><span class="si">}</span><span class="s2"> for db_path: </span><span class="si">{</span><span class="n">db_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">kuzu</span><span class="o">.</span><span class="n">Database</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">kuzu</span><span class="o">.</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Establish a connection to the Kuzu database.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: _connect called in thread ID: </span><span class="si">{</span><span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()</span><span class="si">}</span><span class="s2"> for db_path: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">kuzu</span><span class="o">.</span><span class="n">Database</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: kuzu.Database() successful in thread ID: </span><span class="si">{</span><span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()</span><span class="si">}</span><span class="s2">. DB object: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">kuzu</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: kuzu.Connection() successful in thread ID: </span><span class="si">{</span><span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()</span><span class="si">}</span><span class="s2">. Connection object: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: Error during _connect in thread ID: </span><span class="si">{</span><span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KuzuDB connection error to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

<div class="viewcode-block" id="KuzuAdapter.close">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.close">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the KuzuDB database connection.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: close() called in thread ID: </span><span class="si">{</span><span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()</span><span class="si">}</span><span class="s2"> for db_path: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="si">}</span><span class="s2">. Connection state: </span><span class="si">{</span><span class="s1">&#39;Connected&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Not Connected&#39;</span><span class="si">}</span><span class="s2">, DB state: </span><span class="si">{</span><span class="s1">&#39;Exists&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Kuzu&#39;s Python API documentation suggests that connections and databases</span>
        <span class="c1"># are managed by Python&#39;s garbage collector when they go out of scope.</span>
        <span class="c1"># Explicitly setting to None helps ensure they are dereferenced.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: self.conn set to None for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: self.db set to None for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: close() method finished for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_map_grizabella_to_kuzu_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop_type</span><span class="p">:</span> <span class="n">PropertyDataType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Maps Grizabella PropertyDataType to Kuzu data type strings.&quot;&quot;&quot;</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">PropertyDataType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">:</span> <span class="s2">&quot;STRING&quot;</span><span class="p">,</span>
            <span class="n">PropertyDataType</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">:</span> <span class="s2">&quot;INT64&quot;</span><span class="p">,</span>
            <span class="n">PropertyDataType</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">:</span> <span class="s2">&quot;DOUBLE&quot;</span><span class="p">,</span>
            <span class="n">PropertyDataType</span><span class="o">.</span><span class="n">BOOLEAN</span><span class="p">:</span> <span class="s2">&quot;BOOL&quot;</span><span class="p">,</span>
            <span class="n">PropertyDataType</span><span class="o">.</span><span class="n">DATETIME</span><span class="p">:</span> <span class="s2">&quot;TIMESTAMP&quot;</span><span class="p">,</span>
            <span class="n">PropertyDataType</span><span class="o">.</span><span class="n">BLOB</span><span class="p">:</span> <span class="s2">&quot;BLOB&quot;</span><span class="p">,</span>
            <span class="n">PropertyDataType</span><span class="o">.</span><span class="n">JSON</span><span class="p">:</span> <span class="s2">&quot;STRING&quot;</span><span class="p">,</span>
            <span class="n">PropertyDataType</span><span class="o">.</span><span class="n">UUID</span><span class="p">:</span> <span class="s2">&quot;UUID&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">kuzu_type</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kuzu_type</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unsupported Grizabella data type for Kuzu: </span><span class="si">{</span><span class="n">prop_type</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">SchemaError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kuzu_type</span>

    <span class="c1"># --- Node Table Management ---</span>
<div class="viewcode-block" id="KuzuAdapter.create_node_table">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.create_node_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_node_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">otd</span><span class="p">:</span> <span class="n">ObjectTypeDefinitionModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a Kuzu node table based on an ObjectTypeDefinition if it doesn&#39;t already exist.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuDB not connected&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">existing_node_tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_object_types</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">otd</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">existing_node_tables</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: Node table &#39;</span><span class="si">{</span><span class="n">otd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; already exists. Skipping creation.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: Could not list existing node tables before creating &#39;</span><span class="si">{</span><span class="n">otd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Will attempt creation.&quot;</span><span class="p">)</span>
            <span class="c1"># Proceed to attempt creation if listing fails, Kuzu will error if it exists.</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">properties_str_parts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;id UUID PRIMARY KEY&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">otd</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">data_type</span> <span class="o">!=</span> <span class="n">PropertyDataType</span><span class="o">.</span><span class="n">UUID</span><span class="p">:</span>  <span class="c1"># pylint: disable=W0311</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Property &#39;id&#39; for Kuzu node table &#39;</span><span class="si">{</span><span class="n">otd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; must be UUID &quot;</span>
                            <span class="s2">&quot;type in ObjectTypeDefinition.&quot;</span>
                        <span class="p">)</span>
                        <span class="k">raise</span> <span class="n">SchemaError</span><span class="p">(</span>
                            <span class="n">msg</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">kuzu_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_grizabella_to_kuzu_type</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">data_type</span><span class="p">)</span>
                <span class="n">properties_str_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">kuzu_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">properties_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">properties_str_parts</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CREATE NODE TABLE </span><span class="si">{</span><span class="n">otd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">properties_str</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KuzuDB error creating node table &#39;</span><span class="si">{</span><span class="n">otd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">SchemaError</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>


<div class="viewcode-block" id="KuzuAdapter.drop_node_table">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.drop_node_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">drop_node_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_type_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drops a Kuzu node table.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuDB not connected&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;DROP TABLE </span><span class="si">{</span><span class="n">object_type_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KuzuDB error dropping node table &#39;</span><span class="si">{</span><span class="n">object_type_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">SchemaError</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>


    <span class="c1"># --- Relationship Table Management ---</span>
<div class="viewcode-block" id="KuzuAdapter.create_rel_table">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.create_rel_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_rel_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rtd</span><span class="p">:</span> <span class="n">RelationTypeDefinitionModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a Kuzu relationship table based on a RelationTypeDefinition if it doesn&#39;t already exist.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuDB not connected&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">existing_rel_tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_relation_types</span><span class="p">()</span> <span class="c1"># New method to be added</span>
            <span class="k">if</span> <span class="n">rtd</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">existing_rel_tables</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: Relation table &#39;</span><span class="si">{</span><span class="n">rtd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; already exists. Skipping creation.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: Could not list existing relation tables before creating &#39;</span><span class="si">{</span><span class="n">rtd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Will attempt creation.&quot;</span><span class="p">)</span>
            <span class="c1"># Proceed to attempt creation if listing fails</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">main_properties</span> <span class="o">=</span> <span class="s2">&quot;id UUID, weight DOUBLE, upsert_date TIMESTAMP&quot;</span>
            <span class="n">additional_properties_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">rtd</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;upsert_date&quot;</span><span class="p">]:</span>
                    <span class="n">kuzu_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_grizabella_to_kuzu_type</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">data_type</span><span class="p">)</span>
                    <span class="n">additional_properties_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">kuzu_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">properties_str</span> <span class="o">=</span> <span class="n">main_properties</span>
            <span class="k">if</span> <span class="n">additional_properties_list</span><span class="p">:</span>
                <span class="n">properties_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">additional_properties_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">rtd</span><span class="o">.</span><span class="n">source_object_type_names</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;RTD &#39;</span><span class="si">{</span><span class="n">rtd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; has no source object type names defined.&quot;</span>
                <span class="k">raise</span> <span class="n">SchemaError</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rtd</span><span class="o">.</span><span class="n">target_object_type_names</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;RTD &#39;</span><span class="si">{</span><span class="n">rtd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; has no target object type names defined.&quot;</span>
                <span class="k">raise</span> <span class="n">SchemaError</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">source_table_name</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">.</span><span class="n">source_object_type_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">target_table_name</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">.</span><span class="n">target_object_type_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;CREATE REL TABLE </span><span class="si">{</span><span class="n">rtd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;FROM </span><span class="si">{</span><span class="n">source_table_name</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;TO </span><span class="si">{</span><span class="n">target_table_name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">properties_str</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KuzuDB error creating relationship table &#39;</span><span class="si">{</span><span class="n">rtd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">SchemaError</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>


<div class="viewcode-block" id="KuzuAdapter.drop_rel_table">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.drop_rel_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">drop_rel_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation_type_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drops a Kuzu relationship table.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuDB not connected&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;DROP TABLE </span><span class="si">{</span><span class="n">relation_type_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;KuzuDB error dropping relationship table &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">relation_type_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">SchemaError</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>


    <span class="c1"># --- BaseDBAdapter Method Implementations (Schema-related) ---</span>
<div class="viewcode-block" id="KuzuAdapter.create_object_type">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.create_object_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_object_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="p">:</span> <span class="n">ObjectTypeDefinitionModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a Kuzu node table for the given object type definition.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_node_table</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span></div>


<div class="viewcode-block" id="KuzuAdapter.delete_object_type">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.delete_object_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_object_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drops the Kuzu node table for the given object type name.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_node_table</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="KuzuAdapter.create_relation_type">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.create_relation_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_relation_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="p">:</span> <span class="n">RelationTypeDefinitionModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a Kuzu relationship table for the given relation type definition.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_rel_table</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span></div>


<div class="viewcode-block" id="KuzuAdapter.delete_relation_type">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.delete_relation_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_relation_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes a relation type (drops the Kuzu REL table).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_rel_table</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="KuzuAdapter.get_object_type">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.get_object_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_object_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ObjectTypeDefinitionModel</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Not directly supported by Kuzu schema inspection for full OTD.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="KuzuAdapter.update_object_type">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.update_object_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_object_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="p">:</span> <span class="n">ObjectTypeDefinitionModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Not yet implemented for Kuzu.&quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuAdapter.update_object_type not yet implemented for Kuzu.&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="n">msg</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="KuzuAdapter.list_object_types">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.list_object_types">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_object_types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lists all NODE table names from Kuzu.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuDB not connected&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Updated to include RETURN * as per Kuzu documentation for CALL</span>
            <span class="n">raw_query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CALL SHOW_TABLES() RETURN *;&quot;</span><span class="p">)</span>
            <span class="n">node_tables</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># conn.execute might return a list if multiple statements were run,</span>
            <span class="c1"># but for a single CALL, it should be a single QueryResult.</span>
            <span class="c1"># Handle both cases to satisfy Pylance and be robust.</span>
            <span class="n">actual_query_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">kuzu</span><span class="o">.</span><span class="n">query_result</span><span class="o">.</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_query_result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">raw_query_result</span><span class="p">:</span>
                    <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">actual_query_result</span>
            <span class="p">):</span>  <span class="c1"># Ensure query_result is not None and is a QueryResult</span>
                <span class="n">column_names</span> <span class="o">=</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">has_next</span><span class="p">():</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span>
                    <span class="n">table_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">table_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NODE&quot;</span>
                    <span class="p">):</span>  <span class="c1"># Kuzu uses &#39;type&#39; for table type</span>
                        <span class="n">node_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">node_tables</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KuzuDB error listing object types: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>


<div class="viewcode-block" id="KuzuAdapter.list_relation_types">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.list_relation_types">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_relation_types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lists all REL table names from Kuzu.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuDB not connected&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw_query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CALL SHOW_TABLES() RETURN *;&quot;</span><span class="p">)</span>
            <span class="n">rel_tables</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">actual_query_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">kuzu</span><span class="o">.</span><span class="n">query_result</span><span class="o">.</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_query_result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">raw_query_result</span><span class="p">:</span>
                    <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span>
            
            <span class="k">if</span> <span class="n">actual_query_result</span><span class="p">:</span>
                <span class="n">column_names</span> <span class="o">=</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">has_next</span><span class="p">():</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span>
                    <span class="n">table_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">table_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;REL&quot;</span><span class="p">:</span>
                        <span class="n">rel_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">rel_tables</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KuzuDB error listing relation types: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>


<div class="viewcode-block" id="KuzuAdapter.get_relation_type">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.get_relation_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_relation_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RelationTypeDefinitionModel</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Not directly supported by Kuzu schema inspection for full RTD.&quot;&quot;&quot;</span></div>


    <span class="c1"># --- Object Instance Management (Nodes) ---</span>
<div class="viewcode-block" id="KuzuAdapter.upsert_object_instance">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.upsert_object_instance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">upsert_object_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">ObjectInstance</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ObjectInstance</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Upserts a node into the Kuzu node table corresponding to instance.object_type_name.</span>
<span class="sd">        Uses Kuzu&#39;s MERGE Cypher clause. &#39;id&#39; is the primary key for matching.</span>
<span class="sd">        Maps instance.properties to Kuzu node properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuDB not connected&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">table_name</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">object_type_name</span>

        <span class="c1"># Explicitly type params_for_query and props_for_set</span>
        <span class="n">params_for_query</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id_param&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="c1"># Pass UUID object directly</span>
        <span class="p">}</span>

        <span class="c1"># props_for_set should include &#39;id&#39; and all other properties from instance.properties</span>
        <span class="n">props_for_set</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
        <span class="p">}</span>  <span class="c1"># Kuzu expects UUID as string</span>

        <span class="c1"># Convert all property values to types Kuzu can handle directly in Cypher</span>
        <span class="c1"># For example, datetime to string, UUID to string.</span>
        <span class="c1"># Kuzu&#39;s Python API might handle some conversions, but explicit is safer for $props_for_set.</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># props_for_set is used to gather all properties that need to be in the SET clause</span>
            <span class="c1"># We will ensure correct types when populating params_for_query later.</span>
            <span class="n">props_for_set</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="c1"># Store original types from instance.properties</span>
    
        <span class="c1"># Build SET clause and populate params_for_query with correctly typed values</span>
        <span class="n">set_clause_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Iterate over all properties intended for the node (id + instance.properties)</span>
        <span class="n">all_node_properties</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="o">**</span><span class="n">instance</span><span class="o">.</span><span class="n">properties</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">original_value</span> <span class="ow">in</span> <span class="n">all_node_properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">param_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;p_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">set_clause_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> = $</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Ensure the parameter type matches Kuzu&#39;s expectation for the property</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="c1"># &#39;id&#39; property in Kuzu is UUID</span>
                <span class="n">params_for_query</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span> <span class="c1"># Pass UUID object</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original_value</span><span class="p">,</span> <span class="n">UUID</span><span class="p">):</span> <span class="c1"># Other potential UUID properties</span>
                <span class="n">params_for_query</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_value</span> <span class="c1"># Pass UUID object</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params_for_query</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_value</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_clause_parts</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KuzuDB: No properties to set for object instance </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="n">set_clause_str_on_create</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">set_clause_parts</span><span class="p">)</span>
        
        <span class="c1"># For ON MATCH, exclude setting the &#39;id&#39; property as it&#39;s used for matching.</span>
        <span class="c1"># Only include other properties from instance.properties.</span>
        <span class="n">set_clause_parts_on_match_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">original_value</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="c1"># Iterate only over instance.properties</span>
            <span class="n">param_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;p_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1"># Ensure param_name matches those in params_for_query</span>
            <span class="c1"># We need to ensure that $p_key is actually in params_for_query</span>
            <span class="c1"># params_for_query was built from all_node_properties which includes &#39;id&#39;</span>
            <span class="c1"># So, $p_id will be there, but other $p_key for instance.properties also.</span>
            <span class="n">set_clause_parts_on_match_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> = $</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">on_match_cypher_clause</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">set_clause_parts_on_match_list</span><span class="p">:</span>
            <span class="n">set_clause_str_on_match</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">set_clause_parts_on_match_list</span><span class="p">)</span>
            <span class="n">on_match_cypher_clause</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ON MATCH SET </span><span class="si">{</span><span class="n">set_clause_str_on_match</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># If set_clause_parts_on_match_list is empty (i.e., instance.properties was empty),</span>
        <span class="c1"># then on_match_cypher_clause remains an empty string, and Kuzu&#39;s MERGE</span>
        <span class="c1"># will not have an ON MATCH SET clause, which is valid if no properties need updating.</span>

        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            MERGE (n:</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> </span><span class="se">{{</span><span class="s2">id: $id_param</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">            ON CREATE SET </span><span class="si">{</span><span class="n">set_clause_str_on_create</span><span class="si">}</span>
<span class="s2">            </span><span class="si">{</span><span class="n">on_match_cypher_clause</span><span class="si">}</span>
<span class="s2">            RETURN n.id</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">raw_query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params_for_query</span><span class="p">)</span>

            <span class="n">actual_query_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">kuzu</span><span class="o">.</span><span class="n">query_result</span><span class="o">.</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_query_result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">raw_query_result</span><span class="p">:</span>
                    <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_query_result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">has_next</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;KuzuDB: Upsert for object instance </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> in &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> did not return the expected ID, indicating a potential issue.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">returned_id_val</span> <span class="o">=</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Kuzu might return UUID as kuzu.UUID object or string depending on context/version.</span>
            <span class="c1"># Ensure we compare it correctly with our UUID object.</span>
            <span class="n">returned_id_obj</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">returned_id_val</span><span class="p">,</span> <span class="n">UUID</span><span class="p">):</span>
                <span class="n">returned_id_obj</span> <span class="o">=</span> <span class="n">returned_id_val</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">returned_id_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">returned_id_obj</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="n">returned_id_val</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;KuzuDB: Returned ID &#39;</span><span class="si">{</span><span class="n">returned_id_val</span><span class="si">}</span><span class="s2">&#39; from upsert &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;for table </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> is not a valid UUID string.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                        <span class="n">msg</span><span class="p">,</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
            <span class="c1"># Kuzu&#39;s internal UUID type might be different, check for a &#39;value&#39; attribute</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">returned_id_val</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">returned_id_val</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>  <span class="c1"># type: ignore</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">returned_id_obj</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">returned_id_val</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;KuzuDB: Returned ID value &#39;</span><span class="si">{</span><span class="n">returned_id_val</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; from kuzu object &quot;</span>  <span class="c1"># type: ignore</span>
                        <span class="sa">f</span><span class="s2">&quot;for table </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> is not a valid UUID string.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                        <span class="n">msg</span><span class="p">,</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;KuzuDB: Returned ID from upsert for table </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> has unexpected &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">returned_id_val</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">returned_id_val</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">returned_id_obj</span> <span class="o">!=</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1"># This could indicate a serious issue if Kuzu&#39;s MERGE behaves unexpectedly</span>
                <span class="c1"># or if there&#39;s a type mismatch leading to misinterpretation of ID.</span>
                <span class="c1"># For now, we proceed but this should be monitored.</span>

            <span class="k">return</span> <span class="n">instance</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;KuzuDB error upserting object instance </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;into &#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>


<div class="viewcode-block" id="KuzuAdapter.get_object_instance">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.get_object_instance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_object_instance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">object_type_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ObjectInstance</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves a node by its ID from Kuzu and reconstructs an ObjectInstance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuDB not connected&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Kuzu expects UUID as string for parameter binding</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MATCH (n:</span><span class="si">{</span><span class="n">object_type_name</span><span class="si">}</span><span class="s2"> </span><span class="se">{{</span><span class="s2">id: $instance_id_param</span><span class="se">}}</span><span class="s2">) RETURN n&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;instance_id_param&quot;</span><span class="p">:</span> <span class="n">instance_id</span><span class="p">}</span> <span class="c1"># Pass UUID object</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Ensure params is passed correctly as a dictionary</span>
            <span class="n">raw_query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

            <span class="n">actual_query_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">kuzu</span><span class="o">.</span><span class="n">query_result</span><span class="o">.</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_query_result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">raw_query_result</span><span class="p">:</span>
                    <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_query_result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">has_next</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">node_data_from_kuzu</span> <span class="o">=</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">node_data_from_kuzu</span> <span class="ow">or</span> <span class="s2">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node_data_from_kuzu</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Handle Kuzu&#39;s UUID representation (can be string or kuzu.UUID object)</span>
            <span class="n">retrieved_id_val</span> <span class="o">=</span> <span class="n">node_data_from_kuzu</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
            <span class="n">retrieved_id_obj</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">retrieved_id_val</span><span class="p">,</span> <span class="n">UUID</span><span class="p">):</span>
                <span class="n">retrieved_id_obj</span> <span class="o">=</span> <span class="n">retrieved_id_val</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">retrieved_id_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">retrieved_id_obj</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="n">retrieved_id_val</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;KuzuDB: Retrieved ID &#39;</span><span class="si">{</span><span class="n">retrieved_id_val</span><span class="si">}</span><span class="s2">&#39; from table </span><span class="si">{</span><span class="n">object_type_name</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="s2">&quot;is not a valid UUID string.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                        <span class="n">msg</span><span class="p">,</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">retrieved_id_val</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">retrieved_id_val</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">),</span>
            <span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">retrieved_id_obj</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">retrieved_id_val</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;KuzuDB: Retrieved ID value &#39;</span><span class="si">{</span><span class="n">retrieved_id_val</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; from kuzu object &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;for table </span><span class="si">{</span><span class="n">object_type_name</span><span class="si">}</span><span class="s2"> is not a valid UUID string.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                        <span class="n">msg</span><span class="p">,</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;KuzuDB: Retrieved ID from table </span><span class="si">{</span><span class="n">object_type_name</span><span class="si">}</span><span class="s2"> has unexpected &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">retrieved_id_val</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">retrieved_id_val</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">retrieved_id_obj</span> <span class="o">!=</span> <span class="n">instance_id</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ID mismatch retrieving </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">object_type_name</span><span class="si">}</span><span class="s2">: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">retrieved_id_obj</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">reconstructed_args</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">retrieved_id_obj</span><span class="p">,</span>  <span class="c1"># Use the converted UUID object</span>
                <span class="s2">&quot;object_type_name&quot;</span><span class="p">:</span> <span class="n">object_type_name</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="p">}</span>

            <span class="n">temp_properties</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">node_data_from_kuzu</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span>  <span class="c1"># If &#39;weight&#39; was a defined property in OTD</span>
                    <span class="n">reconstructed_args</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;upsert_date&quot;</span>
                <span class="p">):</span>  <span class="c1"># If &#39;upsert_date&#39; was a defined property in OTD</span>
                    <span class="n">reconstructed_args</span><span class="p">[</span><span class="s2">&quot;upsert_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">temp_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">reconstructed_args</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_properties</span>

            <span class="k">return</span> <span class="n">ObjectInstance</span><span class="p">(</span><span class="o">**</span><span class="n">reconstructed_args</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;KuzuDB error getting object instance </span><span class="si">{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;from &#39;</span><span class="si">{</span><span class="n">object_type_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>


<div class="viewcode-block" id="KuzuAdapter.delete_object_instance">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.delete_object_instance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_object_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_type_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes a node by its ID from Kuzu. Uses DETACH DELETE.</span>
<span class="sd">        Returns True if the node was deleted, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuDB not connected&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Kuzu expects UUID as string for parameter binding</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;MATCH (n:</span><span class="si">{</span><span class="n">object_type_name</span><span class="si">}</span><span class="s2"> </span><span class="se">{{</span><span class="s2">id: $instance_id_param</span><span class="se">}}</span><span class="s2">) DETACH DELETE n&quot;</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;instance_id_param&quot;</span><span class="p">:</span> <span class="n">instance_id</span><span class="p">}</span> <span class="c1"># Pass UUID object</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw_query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

            <span class="n">actual_query_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">kuzu</span><span class="o">.</span><span class="n">query_result</span><span class="o">.</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_query_result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">raw_query_result</span><span class="p">:</span>
                    <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_query_result</span><span class="p">:</span>
                <span class="c1"># This case should ideally not happen if execute ran without error,</span>
                <span class="c1"># but good to be defensive.</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">summary</span> <span class="o">=</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">get_query_summary</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="n">nodes_deleted</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">get_num_nodes_deleted</span><span class="p">()</span> <span class="k">if</span> <span class="n">summary</span> <span class="k">else</span> <span class="mi">0</span>  <span class="c1"># type: ignore[attr-defined]</span>

            <span class="k">return</span> <span class="n">nodes_deleted</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Check for specific Kuzu errors, e.g. table not found (RuntimeError)</span>
            <span class="c1"># kuzu.runtime_error.NotFoundError might be relevant if table doesn&#39;t exist</span>
            <span class="k">if</span> <span class="s2">&quot;NotFoundError&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;Table </span><span class="si">{</span><span class="n">object_type_name</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KuzuDB: Table &#39;</span><span class="si">{</span><span class="n">object_type_name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
                <span class="k">raise</span> <span class="n">SchemaError</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

            <span class="c1"># For other errors, we can say deletion failed.</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="KuzuAdapter.find_object_instances">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.find_object_instances">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_object_instances</span><span class="p">(</span>  <span class="c1"># pylint: disable=R0913</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">object_type_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">ObjectInstance</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Not yet implemented (Subtask 3.2).&quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuAdapter.find_object_instances not yet implemented (Subtask 3.2).&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="n">msg</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="KuzuAdapter.get_all_object_ids_for_type">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.get_all_object_ids_for_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_object_ids_for_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_type_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">UUID</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Kuzu is not typically used to fetch all object IDs for a type without further filtering;</span>
<span class="sd">        this is generally a relational store task for broad ID lists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuAdapter.get_all_object_ids_for_type is not applicable or not implemented.&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


    <span class="c1"># --- Embedding Management (Not applicable for Kuzu) ---</span>
<div class="viewcode-block" id="KuzuAdapter.add_embedding_definition">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.add_embedding_definition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_embedding_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="p">:</span> <span class="n">EmbeddingDefinition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Embedding definitions are not managed by KuzuAdapter.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="KuzuAdapter.get_embedding_definition">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.get_embedding_definition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_embedding_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EmbeddingDefinition</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Embedding definitions are not managed by KuzuAdapter.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="KuzuAdapter.upsert_embedding_instance">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.upsert_embedding_instance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">upsert_embedding_instance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">EmbeddingInstance</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmbeddingInstance</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Not applicable for KuzuAdapter.&quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuAdapter.upsert_embedding_instance is not applicable.&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="n">msg</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="KuzuAdapter.get_embedding_instance">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.get_embedding_instance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_embedding_instance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">embedding_definition_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">object_instance_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EmbeddingInstance</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Not applicable for KuzuAdapter.&quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuAdapter.get_embedding_instance is not applicable.&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="n">msg</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="KuzuAdapter.find_similar_embeddings">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.find_similar_embeddings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_similar_embeddings</span><span class="p">(</span>  <span class="c1"># pylint: disable=R0913</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">embedding_definition_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">EmbeddingInstance</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Not applicable for KuzuAdapter.&quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuAdapter.find_similar_embeddings is not applicable.&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="n">msg</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="c1"># --- Relation Instance Management (Edges) ---</span>
<div class="viewcode-block" id="KuzuAdapter.upsert_relation_instance">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.upsert_relation_instance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">upsert_relation_instance</span><span class="p">(</span>  <span class="c1"># type: ignore # pylint: disable=arguments-differ</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">instance</span><span class="p">:</span> <span class="n">RelationInstance</span><span class="p">,</span>
        <span class="n">rtd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RelationTypeDefinitionModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RelationInstance</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Upserts a relationship in Kuzu between the source_object_instance_id and</span>
<span class="sd">        target_object_instance_id in the table corresponding to instance.relation_type_name.</span>
<span class="sd">        Requires RelationTypeDefinition to know source/target node table names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuDB not connected&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;KuzuAdapter.upsert_relation_instance called with instance: </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="si">=}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">relation_type_name</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">source_object_instance_id</span><span class="si">=}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">source_object_instance_id</span><span class="p">)</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">target_object_instance_id</span><span class="si">=}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">target_object_instance_id</span><span class="p">)</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">weight</span><span class="si">=}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">upsert_date</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">upsert_date</span><span class="p">)</span><span class="si">=}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;properties: </span><span class="si">{</span><span class="w"> </span><span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">instance</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">rtd</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using RTD: </span><span class="si">{</span><span class="n">rtd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, source_types: </span><span class="si">{</span><span class="n">rtd</span><span class="o">.</span><span class="n">source_object_type_names</span><span class="si">}</span><span class="s2">, target_types: </span><span class="si">{</span><span class="n">rtd</span><span class="o">.</span><span class="n">target_object_type_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;RTD is None in upsert_relation_instance&quot;</span><span class="p">)</span>


        <span class="n">rel_table_name</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">relation_type_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rtd</span><span class="p">:</span>
            <span class="c1"># This adapter requires RTD to function, so if it&#39;s None, we cannot proceed.</span>
            <span class="c1"># This aligns with the previous non-optional behavior but now matches the base signature.</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KuzuAdapter.upsert_relation_instance requires &#39;rtd&#39; (RelationTypeDefinition) for relation type &#39;</span><span class="si">{</span><span class="n">rel_table_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rtd</span><span class="o">.</span><span class="n">source_object_type_names</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;RTD &#39;</span><span class="si">{</span><span class="n">rtd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; for relation instance &#39;</span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; has no source object type names.&quot;</span>
            <span class="k">raise</span> <span class="n">SchemaError</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rtd</span><span class="o">.</span><span class="n">target_object_type_names</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;RTD &#39;</span><span class="si">{</span><span class="n">rtd</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; for relation instance &#39;</span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; has no target object type names.&quot;</span>
            <span class="k">raise</span> <span class="n">SchemaError</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">src_node_table</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">.</span><span class="n">source_object_type_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tgt_node_table</span> <span class="o">=</span> <span class="n">rtd</span><span class="o">.</span><span class="n">target_object_type_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">params_for_query</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;src_id_param&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">source_object_instance_id</span><span class="p">,</span> <span class="c1"># Pass UUID object</span>
            <span class="s2">&quot;tgt_id_param&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">target_object_instance_id</span><span class="p">,</span> <span class="c1"># Pass UUID object</span>
            <span class="s2">&quot;rel_id_param&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="c1"># Pass UUID object</span>
        <span class="p">}</span>

        <span class="n">props_for_set</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
            <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">weight</span><span class="p">),</span>  <span class="c1"># Kuzu expects float for DOUBLE</span>
            <span class="s2">&quot;upsert_date&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">upsert_date</span><span class="p">,</span>  <span class="c1"># Kuzu Python API handles datetime to TIMESTAMP</span>
        <span class="p">}</span>
        <span class="c1"># Add custom properties, converting UUIDs to strings</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># props_for_set is used to gather all properties that need to be in the SET clause</span>
            <span class="n">props_for_set</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="c1"># Store original types</span>
    
        <span class="c1"># Build SET clause and populate params_for_query with correctly typed values</span>
        <span class="n">set_clause_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Iterate over all properties intended for the relation (id, weight, upsert_date + instance.properties)</span>
        <span class="n">all_relation_properties</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">weight</span><span class="p">),</span>
            <span class="s2">&quot;upsert_date&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">upsert_date</span><span class="p">,</span>
            <span class="o">**</span><span class="n">instance</span><span class="o">.</span><span class="n">properties</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">original_value</span> <span class="ow">in</span> <span class="n">all_relation_properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">param_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;p_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">set_clause_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;r.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> = $</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Ensure the parameter type matches Kuzu&#39;s expectation</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="c1"># &#39;id&#39; property in Kuzu is UUID</span>
                <span class="n">params_for_query</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span> <span class="c1"># Pass UUID object</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original_value</span><span class="p">,</span> <span class="n">UUID</span><span class="p">):</span> <span class="c1"># Other potential UUID properties</span>
                <span class="n">params_for_query</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_value</span> <span class="c1"># Pass UUID object</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params_for_query</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_value</span>
                
        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_clause_parts</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KuzuDB: No properties to set for relation instance </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">rel_table_name</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">set_clause_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">set_clause_parts</span><span class="p">)</span>

        <span class="c1"># Diagnostic: Check if source node exists</span>
        <span class="n">check_src_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MATCH (s:</span><span class="si">{</span><span class="n">src_node_table</span><span class="si">}</span><span class="s2"> </span><span class="se">{{</span><span class="s2">id: $src_id_param</span><span class="se">}}</span><span class="s2">) RETURN s.id&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: Checking source node existence with query: </span><span class="si">{</span><span class="n">check_src_query</span><span class="si">}</span><span class="s2"> and params: </span><span class="se">{{</span><span class="s2">&#39;src_id_param&#39;: instance.source_object_instance_id</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">src_exists_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">check_src_query</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;src_id_param&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">source_object_instance_id</span><span class="p">})</span>
        
        <span class="n">actual_src_exists_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">kuzu</span><span class="o">.</span><span class="n">query_result</span><span class="o">.</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src_exists_result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">src_exists_result</span><span class="p">:</span>
                <span class="n">actual_src_exists_result</span> <span class="o">=</span> <span class="n">src_exists_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">actual_src_exists_result</span> <span class="o">=</span> <span class="n">src_exists_result</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_src_exists_result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">actual_src_exists_result</span><span class="o">.</span><span class="n">has_next</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: DIAGNOSTIC - Source node </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">source_object_instance_id</span><span class="si">}</span><span class="s2"> NOT FOUND in table </span><span class="si">{</span><span class="n">src_node_table</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: DIAGNOSTIC - Source node </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">source_object_instance_id</span><span class="si">}</span><span class="s2"> FOUND in table </span><span class="si">{</span><span class="n">src_node_table</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># Diagnostic: Check if target node exists</span>
        <span class="n">check_tgt_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MATCH (t:</span><span class="si">{</span><span class="n">tgt_node_table</span><span class="si">}</span><span class="s2"> </span><span class="se">{{</span><span class="s2">id: $tgt_id_param</span><span class="se">}}</span><span class="s2">) RETURN t.id&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: Checking target node existence with query: </span><span class="si">{</span><span class="n">check_tgt_query</span><span class="si">}</span><span class="s2"> and params: </span><span class="se">{{</span><span class="s2">&#39;tgt_id_param&#39;: instance.target_object_instance_id</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tgt_exists_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">check_tgt_query</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tgt_id_param&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">target_object_instance_id</span><span class="p">})</span>

        <span class="n">actual_tgt_exists_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">kuzu</span><span class="o">.</span><span class="n">query_result</span><span class="o">.</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tgt_exists_result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tgt_exists_result</span><span class="p">:</span>
                <span class="n">actual_tgt_exists_result</span> <span class="o">=</span> <span class="n">tgt_exists_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">actual_tgt_exists_result</span> <span class="o">=</span> <span class="n">tgt_exists_result</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_tgt_exists_result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">actual_tgt_exists_result</span><span class="o">.</span><span class="n">has_next</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: DIAGNOSTIC - Target node </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">target_object_instance_id</span><span class="si">}</span><span class="s2"> NOT FOUND in table </span><span class="si">{</span><span class="n">tgt_node_table</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KuzuAdapter: DIAGNOSTIC - Target node </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">target_object_instance_id</span><span class="si">}</span><span class="s2"> FOUND in table </span><span class="si">{</span><span class="n">tgt_node_table</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            MATCH (src:</span><span class="si">{</span><span class="n">src_node_table</span><span class="si">}</span><span class="s2"> </span><span class="se">{{</span><span class="s2">id: $src_id_param</span><span class="se">}}</span><span class="s2">), (tgt:</span><span class="si">{</span><span class="n">tgt_node_table</span><span class="si">}</span><span class="s2"> </span><span class="se">{{</span><span class="s2">id: $tgt_id_param</span><span class="se">}}</span><span class="s2">)</span>
<span class="s2">            MERGE (src)-[r:</span><span class="si">{</span><span class="n">rel_table_name</span><span class="si">}</span><span class="s2"> </span><span class="se">{{</span><span class="s2">id: $rel_id_param</span><span class="se">}}</span><span class="s2">]-&gt;(tgt)</span>
<span class="s2">            ON CREATE SET </span><span class="si">{</span><span class="n">set_clause_str</span><span class="si">}</span>
<span class="s2">            ON MATCH SET </span><span class="si">{</span><span class="n">set_clause_str</span><span class="si">}</span>
<span class="s2">            RETURN r.id</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Kuzu upsert_relation_instance query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Kuzu upsert_relation_instance params_for_query: </span><span class="si">{</span><span class="w"> </span><span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">params_for_query</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw_query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params_for_query</span><span class="p">)</span>

            <span class="n">actual_query_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">kuzu</span><span class="o">.</span><span class="n">query_result</span><span class="o">.</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_query_result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">raw_query_result</span><span class="p">:</span>
                    <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_query_result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">has_next</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;KuzuDB: Upsert for relation instance </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> in &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rel_table_name</span><span class="si">}</span><span class="s2"> did not return the expected ID.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">returned_id_val</span> <span class="o">=</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">returned_id_obj</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">returned_id_val</span><span class="p">,</span> <span class="n">UUID</span><span class="p">):</span>
                <span class="n">returned_id_obj</span> <span class="o">=</span> <span class="n">returned_id_val</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">returned_id_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">returned_id_obj</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="n">returned_id_val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">returned_id_val</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">):</span>  <span class="c1"># kuzu.UUID like</span>
                <span class="n">returned_id_obj</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">returned_id_val</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected type for returned ID: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">returned_id_val</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">returned_id_obj</span> <span class="o">!=</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">return</span> <span class="n">instance</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;KuzuDB error upserting relation instance </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;into &#39;</span><span class="si">{</span><span class="n">rel_table_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>


<div class="viewcode-block" id="KuzuAdapter.get_relation_instance">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.get_relation_instance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_relation_instance</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">relation_type_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">relation_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RelationInstance</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves a relationship by its ID and reconstructs a RelationInstance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuDB not connected&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            MATCH (src)-[r:</span><span class="si">{</span><span class="n">relation_type_name</span><span class="si">}</span><span class="s2"> </span><span class="se">{{</span><span class="s2">id: $rel_id_param</span><span class="se">}}</span><span class="s2">]-&gt;(tgt)</span>
<span class="s2">            RETURN r, src.id AS source_object_instance_id, tgt.id AS target_object_instance_id</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;rel_id_param&quot;</span><span class="p">:</span> <span class="n">relation_id</span><span class="p">}</span> <span class="c1"># Pass UUID object</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw_query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

            <span class="n">actual_query_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">kuzu</span><span class="o">.</span><span class="n">query_result</span><span class="o">.</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_query_result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">raw_query_result</span><span class="p">:</span>
                    <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_query_result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">has_next</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">row</span> <span class="o">=</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span>
            <span class="n">rel_data_from_kuzu</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># The relationship properties</span>
            <span class="n">src_id_str</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">tgt_id_str</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">rel_data_from_kuzu</span> <span class="ow">or</span> <span class="s2">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rel_data_from_kuzu</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">retrieved_id_val</span> <span class="o">=</span> <span class="n">rel_data_from_kuzu</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
            <span class="n">retrieved_id_obj</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">retrieved_id_val</span><span class="p">,</span> <span class="n">UUID</span><span class="p">):</span>
                <span class="n">retrieved_id_obj</span> <span class="o">=</span> <span class="n">retrieved_id_val</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">retrieved_id_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">retrieved_id_obj</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="n">retrieved_id_val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">retrieved_id_val</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">):</span>  <span class="c1"># kuzu.UUID like</span>
                <span class="n">retrieved_id_obj</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">retrieved_id_val</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected type for retrieved relation ID: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">retrieved_id_val</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">retrieved_id_obj</span> <span class="o">!=</span> <span class="n">relation_id</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ID mismatch retrieving relation </span><span class="si">{</span><span class="n">relation_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">relation_type_name</span><span class="si">}</span><span class="s2">: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">relation_id</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">retrieved_id_obj</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">reconstructed_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># Ensure type for Pydantic model</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">retrieved_id_obj</span><span class="p">,</span>
                <span class="s2">&quot;relation_type_name&quot;</span><span class="p">:</span> <span class="n">relation_type_name</span><span class="p">,</span>
                <span class="s2">&quot;source_object_instance_id&quot;</span><span class="p">:</span> <span class="n">UUID</span><span class="p">(</span><span class="n">src_id_str</span><span class="p">),</span>
                <span class="s2">&quot;target_object_instance_id&quot;</span><span class="p">:</span> <span class="n">UUID</span><span class="p">(</span><span class="n">tgt_id_str</span><span class="p">),</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="p">}</span>

            <span class="c1"># Standard properties from MemoryInstance base</span>
            <span class="k">if</span> <span class="s2">&quot;weight&quot;</span> <span class="ow">in</span> <span class="n">rel_data_from_kuzu</span><span class="p">:</span>
                <span class="n">reconstructed_args</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_data_from_kuzu</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;upsert_date&quot;</span> <span class="ow">in</span> <span class="n">rel_data_from_kuzu</span><span class="p">:</span>
                <span class="c1"># Kuzu returns datetime.datetime for TIMESTAMP</span>
                <span class="n">reconstructed_args</span><span class="p">[</span><span class="s2">&quot;upsert_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_data_from_kuzu</span><span class="p">[</span><span class="s2">&quot;upsert_date&quot;</span><span class="p">]</span>

            <span class="n">temp_properties</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rel_data_from_kuzu</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Kuzu internal properties often start with &#39;_&#39; or are specific like &#39;id&#39;, &#39;weight&#39;, &#39;upsert_date&#39;</span>
                <span class="c1"># We only want user-defined properties here.</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;weight&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;upsert_date&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_src&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_dst&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_label&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_id&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="c1"># Convert Kuzu UUID objects back to Python UUID if they are properties</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                        <span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">),</span>
                    <span class="p">):</span>  <span class="c1"># kuzu.UUID like</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">temp_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="n">temp_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># type: ignore If not a valid UUID, keep as string</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">UUID</span><span class="p">):</span>  <span class="c1"># Already a Python UUID</span>
                        <span class="n">temp_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">temp_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">reconstructed_args</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_properties</span>

            <span class="k">return</span> <span class="n">RelationInstance</span><span class="p">(</span><span class="o">**</span><span class="n">reconstructed_args</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;KuzuDB error getting relation instance </span><span class="si">{</span><span class="n">relation_id</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;from &#39;</span><span class="si">{</span><span class="n">relation_type_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>


<div class="viewcode-block" id="KuzuAdapter.find_relation_instances">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.find_relation_instances">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_relation_instances</span><span class="p">(</span>  <span class="c1"># pylint: disable=R0913, R0917, R0912</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">relation_type_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">source_object_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">target_object_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Query on relation properties</span>
        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">RelationInstance</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Queries relationships. Supports filtering by relation type,</span>
<span class="sd">        source node ID, target node ID, and properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuDB not connected&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">relation_type_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">source_object_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">target_object_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
            <span class="c1"># If no specific relation type, source/target ID, or property query is given,</span>
            <span class="c1"># scanning all relations is too broad and potentially resource-intensive.</span>
            <span class="c1"># Return empty list as a sensible default for such an open-ended request.</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># If querying by properties, relation_type_name is mandatory (this is handled later)</span>
        <span class="c1"># if query and not relation_type_name:</span>
        <span class="c1">#     ... raise ValueError ...</span>

        <span class="c1"># If filtering by source/target ID without a specific relation_type_name,</span>
        <span class="c1"># the query MATCH (src)-[r]-&gt;(tgt) can be too broad.</span>
        <span class="c1"># Raise ValueError to make the API contract clear.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">relation_type_name</span> <span class="ow">and</span> <span class="p">(</span><span class="n">source_object_id</span> <span class="ow">or</span> <span class="n">target_object_id</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Querying relations by source/target ID without specifying &quot;</span>
                <span class="s2">&quot;&#39;relation_type_name&#39; is too broad and requires &#39;relation_type_name&#39;.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">where_clauses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Base MATCH clause</span>
        <span class="c1"># If relation_type_name is None, Kuzu requires a more generic match,</span>
        <span class="c1"># and we&#39;ll use TYPE(r) to determine the relation type later.</span>
        <span class="c1"># However, filtering on r&#39;s properties without knowing its type is problematic.</span>
        <span class="n">rel_label_cypher</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">relation_type_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">relation_type_name</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">match_clause</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MATCH (src)-[r</span><span class="si">{</span><span class="n">rel_label_cypher</span><span class="si">}</span><span class="s2">]-&gt;(tgt)&quot;</span>

        <span class="n">cypher_query_parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">match_clause</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">source_object_id</span><span class="p">:</span>
            <span class="n">where_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;src.id = $src_id_param&quot;</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;src_id_param&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_object_id</span> <span class="c1"># Pass UUID object</span>

        <span class="k">if</span> <span class="n">target_object_id</span><span class="p">:</span>
            <span class="n">where_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;tgt.id = $tgt_id_param&quot;</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;tgt_id_param&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_object_id</span> <span class="c1"># Pass UUID object</span>

        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">relation_type_name</span><span class="p">:</span>
                <span class="c1"># This is a practical limitation: Kuzu needs to know the relation type</span>
                <span class="c1"># to correctly interpret property names for filtering.</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Querying by relation properties (using the &#39;query&#39; parameter) &quot;</span>
                    <span class="s2">&quot;requires specifying the &#39;relation_type_name&#39;.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">prop_name</span><span class="p">,</span> <span class="n">prop_value</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">param_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;prop_</span><span class="si">{</span><span class="n">prop_name</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># Ensure unique param names for safety</span>
                <span class="n">where_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;r.</span><span class="si">{</span><span class="n">prop_name</span><span class="si">}</span><span class="s2"> = $</span><span class="si">{</span><span class="n">param_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop_value</span><span class="p">,</span> <span class="n">UUID</span><span class="p">):</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">param_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prop_value</span><span class="p">)</span>
                <span class="c1"># Add other type conversions if Kuzu requires them for specific WHERE clause values</span>
                <span class="c1"># e.g. datetime to Kuzu&#39;s timestamp string format if not handled by driver</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">param_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop_value</span>

        <span class="k">if</span> <span class="n">where_clauses</span><span class="p">:</span>
            <span class="n">cypher_query_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;WHERE &quot;</span> <span class="o">+</span> <span class="s2">&quot; AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where_clauses</span><span class="p">))</span>

        <span class="c1"># Return relationship data, source/target IDs.</span>
        <span class="c1"># If relation_type_name is known, use it directly. Otherwise, try label(r).</span>
        <span class="k">if</span> <span class="n">relation_type_name</span><span class="p">:</span>
            <span class="c1"># We already know the relation_type_name, no need to fetch it from Kuzu&#39;s TYPE() or label().</span>
            <span class="c1"># The actual_relation_type will be this known name.</span>
            <span class="n">cypher_query_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;RETURN r, src.id AS src_node_id, tgt.id AS tgt_node_id&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If relation_type_name was not provided (broader query), try to get it using label(r)</span>
            <span class="c1"># This case is somewhat restricted by earlier checks in the method.</span>
            <span class="n">cypher_query_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;RETURN r, src.id AS src_node_id, tgt.id AS tgt_node_id, label(r) as actual_relation_type_from_kuzu&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">limit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Limit must be a positive integer.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">cypher_query_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;LIMIT </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># Kuzu expects integer literal for LIMIT</span>

        <span class="n">final_query</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cypher_query_parts</span><span class="p">)</span>

        <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RelationInstance</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw_query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">final_query</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

            <span class="n">actual_query_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">kuzu</span><span class="o">.</span><span class="n">query_result</span><span class="o">.</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_query_result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">raw_query_result</span><span class="p">:</span>
                    <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_query_result</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">results</span>

            <span class="k">while</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">has_next</span><span class="p">():</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span>
                <span class="n">rel_data_from_kuzu</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Relationship properties as a dict</span>
                <span class="n">src_id_str</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">tgt_id_str</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="n">actual_rel_type_to_use</span><span class="p">:</span> <span class="nb">str</span>
                <span class="k">if</span> <span class="n">relation_type_name</span><span class="p">:</span>
                    <span class="n">actual_rel_type_to_use</span> <span class="o">=</span> <span class="n">relation_type_name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># This branch is taken if relation_type_name was None in the input,</span>
                    <span class="c1"># and we used label(r) in the query.</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># Check if label(r) was actually returned</span>
                         <span class="n">actual_rel_type_to_use</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># from label(r)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># This should not happen if the query was built correctly for this case.</span>
                        <span class="c1"># Fallback or raise error. For now, let&#39;s try to make it robust.</span>
                        <span class="c1"># If relation_type_name was None, and label(r) wasn&#39;t in RETURN, this is an issue.</span>
                        <span class="c1"># However, the method logic tries to ensure relation_type_name if querying by props.</span>
                        <span class="c1"># If it&#39;s a very generic query, this might be problematic.</span>
                        <span class="c1"># For safety, if it&#39;s missing, we can&#39;t form a valid RelationInstance.</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not determine actual relation type for a found relation.&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>


                <span class="k">if</span> <span class="ow">not</span> <span class="n">rel_data_from_kuzu</span> <span class="ow">or</span> <span class="s2">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rel_data_from_kuzu</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">rel_id_val</span> <span class="o">=</span> <span class="n">rel_data_from_kuzu</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
                <span class="n">rel_id_obj</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_id_val</span><span class="p">,</span> <span class="n">UUID</span><span class="p">):</span>
                    <span class="n">rel_id_obj</span> <span class="o">=</span> <span class="n">rel_id_val</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_id_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rel_id_obj</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="n">rel_id_val</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rel_id_val</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">rel_id_val</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">),</span>
                <span class="p">):</span>  <span class="c1"># kuzu.UUID like</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rel_id_obj</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rel_id_val</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">reconstructed_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">rel_id_obj</span><span class="p">,</span>
                    <span class="s2">&quot;relation_type_name&quot;</span><span class="p">:</span> <span class="n">actual_rel_type_to_use</span><span class="p">,</span>
                    <span class="s2">&quot;source_object_instance_id&quot;</span><span class="p">:</span> <span class="n">src_id_str</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src_id_str</span><span class="p">,</span> <span class="n">UUID</span><span class="p">)</span> <span class="k">else</span> <span class="n">UUID</span><span class="p">(</span><span class="n">src_id_str</span><span class="p">),</span>
                    <span class="s2">&quot;target_object_instance_id&quot;</span><span class="p">:</span> <span class="n">tgt_id_str</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tgt_id_str</span><span class="p">,</span> <span class="n">UUID</span><span class="p">)</span> <span class="k">else</span> <span class="n">UUID</span><span class="p">(</span><span class="n">tgt_id_str</span><span class="p">),</span>
                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="s2">&quot;weight&quot;</span> <span class="ow">in</span> <span class="n">rel_data_from_kuzu</span><span class="p">:</span>
                    <span class="n">reconstructed_args</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_data_from_kuzu</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;upsert_date&quot;</span> <span class="ow">in</span> <span class="n">rel_data_from_kuzu</span><span class="p">:</span>
                    <span class="n">reconstructed_args</span><span class="p">[</span><span class="s2">&quot;upsert_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_data_from_kuzu</span><span class="p">[</span>
                        <span class="s2">&quot;upsert_date&quot;</span>
                    <span class="p">]</span>

                <span class="n">temp_properties</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">internal_kuzu_fields</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;weight&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;upsert_date&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_src&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_dst&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_label&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_id&quot;</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rel_data_from_kuzu</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">internal_kuzu_fields</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                            <span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">),</span>
                        <span class="p">):</span>  <span class="c1"># kuzu.UUID like</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">temp_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
                            <span class="k">except</span> <span class="p">(</span>
                                <span class="ne">ValueError</span>
                            <span class="p">):</span>  <span class="c1"># If not a valid UUID string, store as is</span>
                                <span class="n">temp_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">UUID</span><span class="p">):</span>  <span class="c1"># Already a Python UUID</span>
                            <span class="n">temp_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">temp_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">reconstructed_args</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_properties</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RelationInstance</span><span class="p">(</span><span class="o">**</span><span class="n">reconstructed_args</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">results</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Log the query and params for debugging if needed</span>
            <span class="c1"># print(f&quot;Failed query: {final_query}&quot;)</span>
            <span class="c1"># print(f&quot;Failed params: {params}&quot;)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KuzuDB error finding relation instances: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">InstanceError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>


<div class="viewcode-block" id="KuzuAdapter.delete_relation_instance">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.delete_relation_instance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_relation_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation_type_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">relation_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes a relationship by its ID from Kuzu.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuDB not connected&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MATCH ()-[r:</span><span class="si">{</span><span class="n">relation_type_name</span><span class="si">}</span><span class="s2"> </span><span class="se">{{</span><span class="s2">id: $rel_id_param</span><span class="se">}}</span><span class="s2">]-&gt;() DELETE r&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;rel_id_param&quot;</span><span class="p">:</span> <span class="n">relation_id</span><span class="p">}</span> <span class="c1"># Pass UUID object</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw_query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

            <span class="n">actual_query_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">kuzu</span><span class="o">.</span><span class="n">query_result</span><span class="o">.</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_query_result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">raw_query_result</span><span class="p">:</span>
                    <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_query_result</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">summary</span> <span class="o">=</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">get_query_summary</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="n">rels_deleted</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">get_num_rels_deleted</span><span class="p">()</span> <span class="k">if</span> <span class="n">summary</span> <span class="k">else</span> <span class="mi">0</span>  <span class="c1"># type: ignore[attr-defined]</span>

            <span class="k">return</span> <span class="n">rels_deleted</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;NotFoundError&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;Table </span><span class="si">{</span><span class="n">relation_type_name</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KuzuDB: Table &#39;</span><span class="si">{</span><span class="n">relation_type_name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
                <span class="k">raise</span> <span class="n">SchemaError</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="KuzuAdapter.filter_object_ids_by_relations">
<a class="viewcode-back" href="../../../../db_layers.html#grizabella.db_layers.kuzu.kuzu_adapter.KuzuAdapter.filter_object_ids_by_relations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter_object_ids_by_relations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">source_object_type_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">object_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">UUID</span><span class="p">],</span>
        <span class="n">traversals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">GraphTraversalClause</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">UUID</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filters a list of object IDs, returning only those that satisfy all specified graph traversals.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;KuzuDB not connected&quot;</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">object_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">traversals</span>
        <span class="p">):</span>  <span class="c1"># If no traversals, all initial IDs satisfy the (empty) conditions</span>
            <span class="k">return</span> <span class="n">object_ids</span>

        <span class="n">final_matching_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="n">object_ids</span><span class="p">:</span>
            <span class="n">current_id_satisfies_all</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">traversal_idx</span><span class="p">,</span> <span class="n">traversal</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">traversals</span><span class="p">):</span>
                <span class="c1"># Pass UUID object directly for src_id_param if obj_id is UUID</span>
                <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;src_id_param&quot;</span><span class="p">:</span> <span class="n">obj_id</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_id</span><span class="p">,</span> <span class="n">UUID</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj_id</span><span class="p">)}</span>
                <span class="n">match_parts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">where_clauses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">src_node_label</span> <span class="o">=</span> <span class="n">source_object_type_name</span>
                <span class="n">rel_label</span> <span class="o">=</span> <span class="n">traversal</span><span class="o">.</span><span class="n">relation_type_name</span>
                <span class="n">tgt_node_label</span> <span class="o">=</span> <span class="n">traversal</span><span class="o">.</span><span class="n">target_object_type_name</span>

                <span class="k">if</span> <span class="n">traversal</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;outgoing&quot;</span><span class="p">:</span>
                    <span class="n">path_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(src:</span><span class="si">{</span><span class="n">src_node_label</span><span class="si">}</span><span class="s2"> </span><span class="se">{{</span><span class="s2">id: $src_id_param</span><span class="se">}}</span><span class="s2">) -[rel:</span><span class="si">{</span><span class="n">rel_label</span><span class="si">}</span><span class="s2">]-&gt; (tgt:</span><span class="si">{</span><span class="n">tgt_node_label</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># incoming</span>
                    <span class="n">path_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(src:</span><span class="si">{</span><span class="n">src_node_label</span><span class="si">}</span><span class="s2"> </span><span class="se">{{</span><span class="s2">id: $src_id_param</span><span class="se">}}</span><span class="s2">) &lt;-[rel:</span><span class="si">{</span><span class="n">rel_label</span><span class="si">}</span><span class="s2">]- (tgt:</span><span class="si">{</span><span class="n">tgt_node_label</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="n">match_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_pattern</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">traversal</span><span class="o">.</span><span class="n">target_object_id</span><span class="p">:</span>
                    <span class="n">param_key_tgt_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tgt_id_param_</span><span class="si">{</span><span class="n">traversal_idx</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">where_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tgt.id = $</span><span class="si">{</span><span class="n">param_key_tgt_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># Pass UUID object directly if target_object_id is UUID</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">param_key_tgt_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">traversal</span><span class="o">.</span><span class="n">target_object_id</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">traversal</span><span class="o">.</span><span class="n">target_object_id</span><span class="p">,</span> <span class="n">UUID</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">traversal</span><span class="o">.</span><span class="n">target_object_id</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">traversal</span><span class="o">.</span><span class="n">target_object_properties</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">prop_idx</span><span class="p">,</span> <span class="n">prop_filter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                        <span class="n">traversal</span><span class="o">.</span><span class="n">target_object_properties</span><span class="p">,</span>
                    <span class="p">):</span>
                        <span class="n">prop_name_in_cypher</span> <span class="o">=</span> <span class="n">prop_filter</span><span class="o">.</span><span class="n">property_name</span>
                        <span class="n">param_key_prop_val</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tgt_prop_val_</span><span class="si">{</span><span class="n">traversal_idx</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">prop_idx</span><span class="si">}</span><span class="s2">&quot;</span>

                        <span class="k">if</span> <span class="n">prop_filter</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;IN&quot;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop_filter</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Value for IN operator on property &#39;</span><span class="si">{</span><span class="n">prop_name_in_cypher</span><span class="si">}</span><span class="s2">&#39; must be a list/tuple.&quot;</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                    <span class="n">msg</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">prop_filter</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                                <span class="n">where_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;false&quot;</span><span class="p">)</span>
                                <span class="k">continue</span>

                            <span class="n">list_literal_items</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">prop_filter</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                                    <span class="n">list_literal_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                                    <span class="n">list_literal_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">list_literal_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>

                            <span class="n">where_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;tgt.</span><span class="si">{</span><span class="n">prop_name_in_cypher</span><span class="si">}</span><span class="s2"> IN [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_literal_items</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c1"># For operators like ==, !=, &gt;, &lt; etc.</span>
                            <span class="n">operator_to_use</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span> <span class="k">if</span> <span class="n">prop_filter</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s2">&quot;==&quot;</span> <span class="k">else</span> <span class="n">prop_filter</span><span class="o">.</span><span class="n">operator</span>
                            <span class="c1"># Embed string literals for equality/inequality checks for robustness with Kuzu</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop_filter</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">operator_to_use</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;!=&quot;</span><span class="p">]:</span> <span class="c1"># Refined condition</span>
                                <span class="n">escaped_value</span> <span class="o">=</span> <span class="n">prop_filter</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span>
                                <span class="n">where_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;tgt.</span><span class="si">{</span><span class="n">prop_name_in_cypher</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">operator_to_use</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">escaped_value</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                                <span class="p">)</span>
                                <span class="c1"># No parameter needed as it&#39;s embedded</span>
                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop_filter</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">UUID</span><span class="p">):</span> <span class="c1"># Check if value is UUID</span>
                                <span class="n">where_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;tgt.</span><span class="si">{</span><span class="n">prop_name_in_cypher</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">operator_to_use</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">param_key_prop_val</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                                <span class="n">params</span><span class="p">[</span><span class="n">param_key_prop_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop_filter</span><span class="o">.</span><span class="n">value</span> <span class="c1"># Pass UUID object</span>
                            <span class="k">else</span><span class="p">:</span> <span class="c1"># For numbers, booleans, or other operators with strings</span>
                                <span class="n">where_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;tgt.</span><span class="si">{</span><span class="n">prop_name_in_cypher</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">operator_to_use</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">param_key_prop_val</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                                <span class="n">params</span><span class="p">[</span><span class="n">param_key_prop_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop_filter</span><span class="o">.</span><span class="n">value</span>

                <span class="n">query_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MATCH </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">match_parts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">where_clauses</span><span class="p">:</span>
                    <span class="n">query_str</span> <span class="o">+=</span> <span class="s2">&quot; WHERE &quot;</span> <span class="o">+</span> <span class="s2">&quot; AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where_clauses</span><span class="p">)</span>
                <span class="n">query_str</span> <span class="o">+=</span> <span class="s2">&quot; RETURN count(tgt)&quot;</span> <span class="c1"># Changed from RETURN true LIMIT 1</span>

                <span class="c1"># Diagnostic print (now commented out)</span>
                <span class="c1"># print(f&quot;DEBUG: Query for obj_id {obj_id}, traversal {traversal_idx}:&quot;)</span>
                <span class="c1"># print(f&quot;DEBUG: Query String: {query_str}&quot;)</span>
                <span class="c1"># print(f&quot;DEBUG: Parameters: {params}&quot;)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">prepared_statement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">query_str</span><span class="p">)</span>
                    <span class="n">raw_query_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="n">prepared_statement</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">actual_query_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">kuzu</span><span class="o">.</span><span class="n">query_result</span><span class="o">.</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_query_result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">raw_query_result</span><span class="p">:</span>
                            <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">actual_query_result</span> <span class="o">=</span> <span class="n">raw_query_result</span>
    
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_query_result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">has_next</span><span class="p">():</span>
                            <span class="n">current_id_satisfies_all</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                        
                        <span class="c1"># If query is &quot;RETURN count(tgt)&quot;, get_next()[0] will be the count</span>
                        <span class="n">count_result</span> <span class="o">=</span> <span class="n">actual_query_result</span><span class="o">.</span><span class="n">get_next</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">count_result</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">count_result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">current_id_satisfies_all</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">runtime_kuzu_error</span><span class="p">:</span> <span class="c1"># Catch generic RuntimeError</span>
                    <span class="n">err_msg_lower</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">runtime_kuzu_error</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="c1"># Check for common Kuzu messages indicating a schema problem (e.g., table not found, binder issues)</span>
                    <span class="c1"># These are typically indicative of issues Kuzu itself reports at a schema/query binding level.</span>
                    <span class="n">is_kuzu_schema_issue</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="s2">&quot;table&quot;</span> <span class="ow">in</span> <span class="n">err_msg_lower</span> <span class="ow">and</span> <span class="s2">&quot;does not exist&quot;</span> <span class="ow">in</span> <span class="n">err_msg_lower</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="p">(</span><span class="s2">&quot;binder exception&quot;</span> <span class="ow">in</span> <span class="n">err_msg_lower</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="p">(</span><span class="s2">&quot;catalog exception&quot;</span> <span class="ow">in</span> <span class="n">err_msg_lower</span><span class="p">)</span> <span class="ow">or</span> <span class="c1"># Another common Kuzu schema error</span>
                        <span class="p">(</span><span class="s2">&quot;cannot delete node table&quot;</span> <span class="ow">in</span> <span class="n">err_msg_lower</span> <span class="ow">and</span> <span class="s2">&quot;referenced by relationship&quot;</span> <span class="ow">in</span> <span class="n">err_msg_lower</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_kuzu_schema_issue</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SchemaError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Kuzu schema/binder error during traversal query: </span><span class="si">{</span><span class="n">runtime_kuzu_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">runtime_kuzu_error</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># For other RuntimeErrors not identified as schema issues,</span>
                        <span class="c1"># assume the traversal for this specific obj_id failed.</span>
                        <span class="n">current_id_satisfies_all</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">SchemaError</span><span class="p">,</span> <span class="n">DatabaseError</span><span class="p">)</span> <span class="k">as</span> <span class="n">db_exc</span><span class="p">:</span> <span class="c1"># Our own specific errors</span>
                    <span class="k">raise</span> <span class="n">db_exc</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1"># Catch-all for other truly unexpected errors (non-Runtime, non-Grizabella specific)</span>
                    <span class="n">current_id_satisfies_all</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">current_id_satisfies_all</span><span class="p">:</span>
                <span class="n">final_matching_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_matching_ids</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Grizabella Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>